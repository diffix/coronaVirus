<!DOCTYPE html>
<html lang='en-US'>
<head>
    <meta charset='utf-8' />

    <link rel="icon" type="image/png" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/favicon-32x32.png?ver=1.7.0" />

    <link rel="icon" type="image/png" sizes="192x192"  href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/android-icon-192x192.png?ver=1.7.0">
	<link rel="icon" type="image/png" sizes="32x32" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/favicon-32x32.png?ver=1.7.0">
	<link rel="icon" type="image/png" sizes="96x96" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/favicon-96x96.png?ver=1.7.0">
	<link rel="icon" type="image/png" sizes="16x16" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/favicon-16x16.png?ver=1.7.0">


	<link rel="apple-touch-icon" sizes="57x57" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-57x57.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="60x60" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-60x60.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="72x72" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-72x72.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="76x76" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-76x76.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="114x114" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-114x114.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="120x120" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-120x120.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="144x144" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-144x144.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="152x152" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-152x152.png?ver=1.7.0">
	<link rel="apple-touch-icon" sizes="180x180" href="https://www.mpi-sws.org/wp-content/themes/mpi-sws/assets/images/favicon/apple-icon-180x180.png?ver=1.7.0">

    <title>Heatmap</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .map-overlay-top {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            top: 0;
            left: 0;
            width: 250px;
            padding: 10px;
        }

        .map-overlay-bottom {
            background-color: rgba(255, 255, 255, 0.8);
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            text-align: center;
            position: absolute;
            bottom: 0;
            right: 0;
            width: 273px;
            padding-bottom: 20px;
        }

        .map-overlay-top .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .map-overlay-top h2 {
            line-height: 24px;
            display: block;
            margin: 0 0 10px;
        }
        .map-overlay-top h3 {
            display: block;
            margin: 0 0 0;
            font-weight: normal;
            font-style: italic;
        }
        .map-overlay-top p {
            margin-top: 15px;
            margin-bottom: 0;
        }
        .map-overlay-top input {
            background-color: transparent;
            display: inline-block;
            position: relative;
            margin: 0;
            cursor: ew-resize;
        }
        .slider {
            width: 100%;
        }
        .check {
            width: 10%;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    <div class="map-overlay-top">
        <div class="map-overlay-inner">
            <h2 id="title">Heatmap</h2>
            <h3 id="subtitle">Heatmap</h3>
            <p>
                <label id="date" for="dSlider">Loading ...</label>
                <input class="slider" id="dSlider" type="range" min="0" max="7" step="1" value="0"/>
                <label id="time" for="tSlider">Loading ...</label>
                <input class="slider" id="tSlider" type="range" min="0" max="23" step="1" value="0"/>
            </p>
            <p>
                <label id="animationSpeed" for="asSlider">Animation step every: 0.5s</label>
                <input class="slider" id="asSlider" type="range" min="1" max="11" step="1" value="1"/>
                <button id="animationButton" type="button">Start Animation</button>
            </p>
            <p>
                <input class="check" id="shCheck" type="checkbox" checked/>
                <label id="showHeatmap" for="shCheck">Show heatmap</label><br>
                <input class="check" id="srdCheck" type="checkbox" checked/>
                <label id="showRawData" for="srdCheck">Show raw data</label>
            </p>
        </div>
    </div>
    <div class="map-overlay-bottom">
        <a href="https://imprint.mpi-klsb.mpg.de/sws/people/cmickler">Imprint</a> / <a href="https://data-protection.mpi-klsb.mpg.de/sws/people/cmickler">Data Protection</a>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        document.title = urlParams.get('title');
        document.getElementById('title').textContent = urlParams.get('title');
        document.getElementById('subtitle').textContent = urlParams.get('subtitle');
        const startSeconds = parseInt(urlParams.get('startSeconds'), 10);
        const geoWidth = parseFloat(urlParams.get('geoWidth'));
        const zoomOffset = Math.log2(geoWidth / 0.0001).toFixed(1);
        let timer = null;

        function startAnimation() {
            if (timer !== null) {
                clearInterval(timer);
            }
            document.getElementById('animationButton').textContent = "Stop Animation";
            timer = setInterval(doAnimation, parseInt(document.getElementById('asSlider').value, 10) * 500);
        }

        function stopAnimation() {
            if (timer === null) {
                return;
            }
            clearInterval(timer);
            timer = null;
            document.getElementById('animationButton').textContent = "Start Animation";
        }

        function updateAnimation() {
            if (timer === null) {
                return;
            }
            startAnimation();
        }

        function toggleAnimation() {
            if (timer === null) {
                startAnimation();
            } else {
                stopAnimation();
            }
        }

        function doAnimation() {
            if (!incrementAnimation()) {
                stopAnimation();
            }
        }

        function incrementAnimation() {
            let tSlider = document.getElementById('tSlider');
            if (parseInt(tSlider.value, 10) < parseInt(tSlider.max, 10)) {
                tSlider.stepUp();
                updateFilter();
                return true;
            } else {
                let dSlider = document.getElementById('dSlider');
                if (parseInt(dSlider.value, 10) < parseInt(dSlider.max, 10)) {
                    tSlider.value = tSlider.min;
                    dSlider.stepUp();
                    updateFilter();
                    return true;
                } else {
                    return false;
                }
            }
        }

        function updateFilter() {
            const tChoice = parseInt(document.getElementById('tSlider').value, 10);
            const dChoice = parseInt(document.getElementById('dSlider').value, 10);
            filterBy(startSeconds + dChoice * 86400 + tChoice * 3600);
        }

        function filterBy(seconds) {
            let filters = ['==', 'time', seconds];
            map.setFilter('heatmap', filters);
            map.setFilter('cloakDataRectangles', filters);
            map.setFilter('cloakDataCounts', filters);
            let date = new Date(seconds * 1000)
            document.getElementById('date').textContent = 'Date: ' + date.toLocaleDateString();
            document.getElementById('time').textContent = 'Time: ' + `${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
        }

        mapboxgl.accessToken = urlParams.get('accessToken');
        let map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v11',
            center: [7.768, 49.443],
            zoom: 13
        });
        map.on('load', function() {
            map.addSource('polygons', {
                type: 'geojson',
                data: urlParams.get('polygonsFilePath')
            });
            map.addSource('centers', {
                type: 'geojson',
                data: urlParams.get('centersFilePath')
            });
            map.addLayer({
                id: 'heatmap',
                type: 'heatmap',
                source: 'centers',
                minzoom: 10,
                layout: {
                    'visibility': 'visible'
                },
                paint: {
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0, 'rgba(0,0,255,0)',
                        0.05, 'rgb(65,105,225)',
                        0.35, 'rgb(0,255,255)',
                        0.65, 'rgb(0,255,0)',
                        0.95, 'rgb(255,255,0)',
                        1, 'rgb(255,0,0)'
                    ],
                    'heatmap-opacity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        10, 0,
                        11, 0.6,
                        15.5, 0.6,
                        16.5, 0.4
                    ],
                    'heatmap-radius': [
                        'interpolate',
                        ['exponential', 1.99],
                        ['zoom'],
                        0, 1,
                        22, Math.round(10000000 * geoWidth)
                    ],
                    'heatmap-weight': ['get', 'encounters'],
                    'heatmap-intensity': 0.01
                }
            }, 'waterway-label');
            map.addLayer({
                id: 'cloakDataRectangles',
                type: 'fill',
                source: 'polygons',
                minzoom: Math.max(10, 15-zoomOffset),
                layout: {
                    'visibility': 'visible'
                },
                paint: {
                    'fill-color': 'rgba(255,255,255,0)',
                    'fill-opacity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15.5 - zoomOffset, 0,
                        16 - zoomOffset, 0.1
                    ],
                    'fill-outline-color': 'rgb(0,0,0)'
                }
            }, 'waterway-label');
            map.addLayer({
                id: 'cloakDataCounts',
                type: 'symbol',
                source: 'centers',
                minzoom: Math.max(10, 16-zoomOffset),
                layout: {
                    'visibility': 'visible',
                    'text-allow-overlap': true,
                    'text-ignore-placement': true,
                    'text-field': ['to-string', ['get', 'encounters']],
                    'text-size': [
                        'interpolate',
                        ['exponential', 1.99],
                        ['zoom'],
                        0, 1,
                        22, Math.round(2000000 * geoWidth)
                    ]
                },
                paint: {
                    'text-opacity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        16.5 - zoomOffset, 0,
                        17 - zoomOffset, 0.4,
                        21.5 - zoomOffset, 0.4,
                        22 - zoomOffset, 0
                    ]
                }
            });
            filterBy(startSeconds);
            document
                .getElementById('tSlider')
                .addEventListener('input', function () {
                    updateFilter();
                });
            document
                .getElementById('dSlider')
                .addEventListener('input', function () {
                    updateFilter();
                });
            document
                .getElementById('asSlider')
                .addEventListener('input', function (e) {
                    let asChoice = parseInt(e.target.value, 10) - 1;
                    if (asChoice === 0) {
                        asChoice = 0.5;
                    }
                    document.getElementById('animationSpeed').textContent = "Animation step every: " + asChoice + "s"
                    updateAnimation();
                });
            document
                .getElementById('animationButton')
                .addEventListener('click', function () {
                    toggleAnimation();
                });
            document
                .getElementById('shCheck')
                .addEventListener('change', function (e) {
                    if (e.target.checked) {
                        map.setLayoutProperty('heatmap', 'visibility', 'visible');
                    } else {
                        map.setLayoutProperty('heatmap', 'visibility', 'none');
                    }
                });
            document
                .getElementById('srdCheck')
                .addEventListener('change', function (e) {
                    if (e.target.checked) {
                        map.setLayoutProperty('cloakDataRectangles', 'visibility', 'visible');
                        map.setLayoutProperty('cloakDataCounts', 'visibility', 'visible');
                    } else {
                        map.setLayoutProperty('cloakDataRectangles', 'visibility', 'none');
                        map.setLayoutProperty('cloakDataCounts', 'visibility', 'none');
                    }
                });
        });
    </script>
</body>
</html>